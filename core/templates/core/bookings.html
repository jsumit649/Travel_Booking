{% extends 'main.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="page-title mb-0">
                    <i class="fas fa-ticket-alt me-2"></i>My Bookings
                </h2>
                <a href="{% url 'travel-options' %}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>New Booking
                </a>
            </div>
        </div>
    </div>
    
    <!-- Loading Spinner -->
    <div id="loading-spinner" class="text-center my-5" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading your bookings...</p>
    </div>
    
    <!-- Bookings Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Booking History</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>Reference</th>
                                    <th>Travel Details</th>
                                    <th>Passengers</th>
                                    <th>Total Price</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="bookings-table">
                                <!-- Bookings will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- No Bookings Message -->
    <div id="no-bookings" class="text-center my-5" style="display: none;">
        <i class="fas fa-ticket-alt fa-3x text-muted mb-3"></i>
        <h4>No bookings found</h4>
        <p class="text-muted">You haven't made any bookings yet. Start your journey by searching for travel options!</p>
        <a href="{% url 'travel-options' %}" class="btn btn-primary">
            <i class="fas fa-search me-2"></i>Search Travel Options
        </a>
    </div>
</div>

<script>
// Load bookings on page load
document.addEventListener('DOMContentLoaded', async function() {
    try {
        showLoading(true);
        const data = await makeRequest('/api/bookings/');
        displayBookings(data.results || data);
    } catch (error) {
        console.error('Failed to load bookings:', error);
        showNoBookings();
    } finally {
        showLoading(false);
    }
});

// Show/hide loading spinner
function showLoading(show) {
    const spinner = document.getElementById('loading-spinner');
    const table = document.querySelector('.card');
    const noBookings = document.getElementById('no-bookings');
    
    if (show) {
        spinner.style.display = 'block';
        table.style.display = 'none';
        noBookings.style.display = 'none';
    } else {
        spinner.style.display = 'none';
        table.style.display = 'block';
    }
}

// Show no bookings message
function showNoBookings() {
    const spinner = document.getElementById('loading-spinner');
    const table = document.querySelector('.card');
    const noBookings = document.getElementById('no-bookings');
    
    spinner.style.display = 'none';
    table.style.display = 'none';
    noBookings.style.display = 'block';
}

// Format price in INR
function formatPriceINR(price) {
    return new Intl.NumberFormat('en-IN', {
        style: 'currency',
        currency: 'INR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(price);
}

// Display bookings in table
function displayBookings(bookings) {
    const tableBody = document.getElementById('bookings-table');
    const noBookings = document.getElementById('no-bookings');
    
    if (!bookings || bookings.length === 0) {
        showNoBookings();
        return;
    }
    
    noBookings.style.display = 'none';
    
    const html = bookings.map(booking => `
        <tr>
            <td>
                <div class="booking-reference">
                    <strong>${booking.reference_number}</strong>
                    <br>
                    <small class="text-muted">${formatDate(booking.booking_date)}</small>
                </div>
            </td>
            <td>
                <div class="travel-details">
                    <div class="travel-type">
                        <span class="badge bg-${getTypeColor(booking.travel_option.type)}">${booking.travel_option.type.toUpperCase()}</span>
                        <span class="badge bg-secondary">${booking.travel_option.operator_name}</span>
                    </div>
                    <div class="route">
                        <i class="fas fa-${getRouteIcon(booking.travel_option.type)} text-primary"></i>
                        ${booking.travel_option.source} â†’ ${booking.travel_option.destination}
                    </div>
                    <div class="route">
                        <i class="fas fa-calendar-alt text-muted"></i>
                        ${formatDate(booking.travel_option.departure_date)} at ${booking.travel_option.departure_time}
                    </div>
                </div>
            </td>
            <td>
                <div class="passenger-info">
                    <strong>${booking.number_of_seats} passenger${booking.number_of_seats > 1 ? 's' : ''}</strong>
                    <br>
                    <small class="text-muted">${getPassengerNames(booking.passenger_details)}</small>
                </div>
            </td>
            <td>
                <div class="price-info">
                    <strong class="text-success">${formatPriceINR(booking.total_price)}</strong>
                </div>
            </td>
            <td>
                <span class="badge bg-${getStatusColor(booking.status)}">${booking.status.toUpperCase()}</span>
            </td>
            <td>
                <div class="booking-actions">
                    <a href="/booking-details/?id=${booking.booking_id}" class="btn btn-sm btn-primary">
                        <i class="fas fa-eye"></i> Details
                    </a>
                    ${booking.status === 'confirmed' ? `
                        <button class="btn btn-sm btn-danger" onclick="cancelBooking(${booking.booking_id})">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    ` : ''}
                </div>
            </td>
        </tr>
    `).join('');
    
    tableBody.innerHTML = html;
}

// Helper function to get color for travel type
function getTypeColor(type) {
    switch(type) {
        case 'flight': return 'primary';
        case 'train': return 'success';
        case 'bus': return 'warning';
        default: return 'secondary';
    }
}

// Helper function to get appropriate icon for travel type
function getRouteIcon(type) {
    switch(type) {
        case 'flight': return 'plane';
        case 'train': return 'train';
        case 'bus': return 'bus';
        default: return 'map-marker-alt';
    }
}

// Helper function to get status color
function getStatusColor(status) {
    switch(status) {
        case 'confirmed': return 'success';
        case 'pending': return 'warning';
        case 'cancelled': return 'danger';
        default: return 'secondary';
    }
}

// Helper function to format date
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-IN', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
    });
}

// Helper function to get passenger names
function getPassengerNames(passengerDetails) {
    if (!passengerDetails || !Array.isArray(passengerDetails)) {
        return 'N/A';
    }
    
    const names = passengerDetails.map(passenger => passenger.name || 'Unknown').slice(0, 2);
    if (passengerDetails.length > 2) {
        names.push(`+${passengerDetails.length - 2} more`);
    }
    return names.join(', ');
}

// View booking details - Navigate to booking details page
function viewBookingDetails(bookingId) {
    window.location.href = `/booking-details/?id=${bookingId}`;
}

// Cancel booking
async function cancelBooking(bookingId) {
    if (!confirm('Are you sure you want to cancel this booking? This action cannot be undone.')) {
        return;
    }
    
    try {
        await makeRequest(`/api/bookings/${bookingId}/cancel/`, {
            method: 'POST'
        });
        
        showToast('Booking cancelled successfully!', 'success');
        
        // Reload the page to show updated data
        setTimeout(() => {
            window.location.reload();
        }, 2000);
    } catch (error) {
        console.error('Cancellation failed:', error);
        showToast('Failed to cancel booking. Please try again.', 'error');
    }
}
</script>
{% endblock %}

