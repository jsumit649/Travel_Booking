{% extends 'main.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="page-title mb-0">
                    <i class="fas fa-ticket-alt me-2"></i>My Bookings
                </h2>
                <a href="{% url 'travel-options' %}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>New Booking
                </a>
            </div>
        </div>
    </div>
    
    <!-- Loading Spinner -->
    <div id="loading-spinner" class="text-center my-5" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading your bookings...</p>
    </div>
    
    <!-- Bookings Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Booking History</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>Reference</th>
                                    <th>Travel Details</th>
                                    <th>Passengers</th>
                                    <th>Total Price</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="bookings-table">
                                <!-- Bookings will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- No Bookings Message -->
    <div id="no-bookings" class="text-center my-5" style="display: none;">
        <i class="fas fa-ticket-alt fa-3x text-muted mb-3"></i>
        <h4>No bookings found</h4>
        <p class="text-muted">You haven't made any bookings yet. Start your journey by searching for travel options!</p>
        <a href="{% url 'travel-options' %}" class="btn btn-primary">
            <i class="fas fa-search me-2"></i>Search Travel Options
        </a>
    </div>
</div>

<script>
// Load bookings on page load
document.addEventListener('DOMContentLoaded', async function() {
    try {
        showLoading(true);
        const data = await makeRequest('/api/bookings/');
        displayBookings(data.results || data);
    } catch (error) {
        console.error('Failed to load bookings:', error);
        showNoBookings();
    } finally {
        showLoading(false);
    }
});

// Show/hide loading spinner
function showLoading(show) {
    const spinner = document.getElementById('loading-spinner');
    const table = document.querySelector('.card');
    const noBookings = document.getElementById('no-bookings');
    
    if (show) {
        spinner.style.display = 'block';
        table.style.display = 'none';
        noBookings.style.display = 'none';
    } else {
        spinner.style.display = 'none';
        table.style.display = 'block';
    }
}

// Show no bookings message
function showNoBookings() {
    const spinner = document.getElementById('loading-spinner');
    const table = document.querySelector('.card');
    const noBookings = document.getElementById('no-bookings');
    
    spinner.style.display = 'none';
    table.style.display = 'none';
    noBookings.style.display = 'block';
}

function displayBookings(bookings) {
    const tableBody = document.getElementById('bookings-table');
    
    if (!bookings || bookings.length === 0) {
        showNoBookings();
        return;
    }
    
    const html = bookings.map(booking => `
        <tr>
            <td>
                <div class="booking-reference">
                    <strong>${booking.reference_number}</strong>
                    <small class="text-muted d-block">${formatDate(booking.booking_date)}</small>
                </div>
            </td>
            <td>
                <div class="travel-details">
                    <div class="travel-type">
                        <span class="badge bg-${getTypeColor(booking.travel_option.type)}">${booking.travel_option.type.toUpperCase()}</span>
                        <strong>${booking.travel_option.operator_name}</strong>
                    </div>
                    <div class="route">
                        <i class="fas fa-arrow-right text-muted"></i>
                        ${booking.travel_option.source} â†’ ${booking.travel_option.destination}
                    </div>
                    <small class="text-muted">
                        ${formatDate(booking.travel_option.departure_date)} at ${booking.travel_option.departure_time}
                    </small>
                </div>
            </td>
            <td>
                <div class="passenger-info">
                    <span class="badge bg-info">${booking.number_of_seats} ${booking.number_of_seats === 1 ? 'passenger' : 'passengers'}</span>
                    ${booking.passenger_details ? `<small class="text-muted d-block">${booking.passenger_details.length} details provided</small>` : ''}
                </div>
            </td>
            <td>
                <div class="price-info">
                    <strong class="text-success">$${booking.total_price}</strong>
                </div>
            </td>
            <td>
                <span class="badge bg-${getStatusColor(booking.status)}">${booking.status}</span>
            </td>
            <td>
                <div class="booking-actions">
                    ${booking.status === 'confirmed' ? 
                        `<button class="btn btn-sm btn-danger" onclick="cancelBooking(${booking.booking_id})">
                            <i class="fas fa-times me-1"></i>Cancel
                        </button>` : 
                        ''
                    }
                    <button class="btn btn-sm btn-outline-primary" onclick="viewBookingDetails(${booking.booking_id})">
                        <i class="fas fa-eye me-1"></i>Details
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
    
    tableBody.innerHTML = html;
}

// Helper function to get color for travel type
function getTypeColor(type) {
    switch(type) {
        case 'flight': return 'primary';
        case 'train': return 'success';
        case 'bus': return 'warning';
        default: return 'secondary';
    }
}

// Helper function to get color for booking status
function getStatusColor(status) {
    switch(status) {
        case 'confirmed': return 'success';
        case 'pending': return 'warning';
        case 'cancelled': return 'danger';
        default: return 'secondary';
    }
}

// Helper function to format date
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
    });
}

// View booking details
function viewBookingDetails(bookingId) {
    // This could open a modal or navigate to a details page
    alert('Booking details feature coming soon!');
}

// Cancel booking
async function cancelBooking(bookingId) {
    if (!confirm('Are you sure you want to cancel this booking? This action cannot be undone.')) {
        return;
    }
    
    try {
        await makeRequest(`/api/bookings/${bookingId}/cancel/`, {
            method: 'POST'
        });
        
        showToast('Booking cancelled successfully!', 'success');
        
        // Reload the page to show updated data
        setTimeout(() => {
            window.location.reload();
        }, 2000);
    } catch (error) {
        console.error('Cancellation failed:', error);
        showToast('Failed to cancel booking. Please try again.', 'error');
    }
}
</script>
{% endblock %}
```

